# Система загрузки и отображения файлов - UmbraPL

## Обзор

Этот документ описывает полностью исправленную систему загрузки и отображения файлов в редакторе документации проекта UmbraPL.

## Исправленные проблемы

### 1. Проблемы с путями файлов
- ✅ **Исправлено**: Middleware теперь правильно обрабатывает статические файлы `/uploads/*`
- ✅ **Исправлено**: Next.js конфигурация добавляет правильные заголовки для статических файлов
- ✅ **Исправлено**: API загрузки поддерживает как локальную разработку, так и production на Render

### 2. Проблемы с временными blob URL
- ✅ **Исправлено**: ModernArticleEditor теперь загружает файлы через API вместо создания временных blob URL
- ✅ **Исправлено**: Все загруженные файлы сохраняются на сервере и получают постоянные URL

### 3. Проблемы с отображением в DocumentationRenderer
- ✅ **Исправлено**: Добавлена функция `normalizeFileUrl()` для корректной обработки путей
- ✅ **Исправлено**: Добавлен fallback для случаев ошибки загрузки изображений

### 4. Поддержка Render хранилища
- ✅ **Исправлено**: API автоматически определяет окружение и использует правильные пути
- ✅ **Исправлено**: В production файлы сохраняются в `/uploads` (соответствует настройке Render)
- ✅ **Исправлено**: В development файлы сохраняются в `public/uploads`

## Архитектура решения

### Компоненты

1. **FileUploader** (`src/components/admin/FileUploader.tsx`)
   - Универсальный компонент для загрузки файлов
   - Поддержка drag&drop
   - Валидация типов и размеров файлов
   - Интеграция с toast уведомлениями

2. **ModernArticleEditor** (`src/components/editor/ModernArticleEditor.tsx`)
   - Исправлен drag&drop для загрузки файлов через API
   - FilesSidebar теперь использует реальную загрузку

3. **AdvancedContentEditor** (`src/components/admin/documentation/AdvancedContentEditor.tsx`)
   - Интегрирован с системой загрузки файлов
   - Поддержка изображений и файлов в блоках

4. **DocumentationRenderer** (`src/components/docs/DocumentationRenderer.tsx`)
   - Корректное отображение загруженных файлов
   - Fallback для ошибок загрузки изображений

### API Endpoints

1. **POST /api/admin/upload**
   - Загрузка файлов с валидацией
   - Автоматическое определение окружения (dev/production)
   - Поддержка изображений и документов

2. **GET /api/uploads/[...path]** (fallback)
   - Дополнительный endpoint для обслуживания файлов
   - Использует корректные MIME типы
   - Поддержка кеширования

### Утилиты

1. **file-utils.ts** (`src/lib/file-utils.ts`)
   - `normalizeFileUrl()` - нормализация путей к файлам
   - `isImageFile()` - определение типа файла
   - `formatFileSize()` - форматирование размера файлов
   - Другие вспомогательные функции

### Тестирование

Система загрузки файлов интегрирована в редактор документации и другие компоненты платформы. Тестирование происходит в процессе использования.

## Конфигурация

### Next.js (next.config.js)
```javascript
// Заголовки для статических файлов
{
  source: '/uploads/:path*',
  headers: [
    { key: 'Cache-Control', value: 'public, max-age=31536000, immutable' },
  ],
}

// Перезапись путей для Render
async rewrites() {
  return [
    {
      source: '/uploads/:path*',
      destination: '/uploads/:path*',
    },
  ];
}
```

### Middleware (src/middleware.ts)
```javascript
// Исключаем uploads из middleware
"/((?!_next/static|_next/image|favicon.ico|uploads|.*\\.).*)"
```

### API загрузки
```javascript
// Автоматическое определение окружения
const isProduction = process.env.NODE_ENV === 'production';
const uploadsPath = isProduction 
  ? join('/uploads', uploadDir.replace('uploads/', ''))
  : join(process.cwd(), 'public', uploadDir);
```

## Поддерживаемые форматы

### Изображения
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)
- SVG (.svg)

### Документы
- PDF (.pdf)
- Текстовые файлы (.txt)
- Microsoft Office (Word, Excel, PowerPoint)
- Архивы (ZIP, RAR, 7Z)

### Медиа
- Аудио (MP3, WAV)
- Видео (MP4, WebM)

### Другие
- JSON (.json)
- CSV (.csv)

## Настройка Render

### Хранилище
Убедитесь, что в настройках Render service создана папка `/uploads` с правами на запись.

### Переменные окружения
- `NODE_ENV=production` - для корректного определения окружения

### Файловая система
- Development: `public/uploads/images/` и `public/uploads/files/`
- Production: `/uploads/images/` и `/uploads/files/`

## Использование

### В редакторе документации
1. Перетащите файл в область редактора
2. Или используйте кнопку "Загрузить" в боковой панели
3. Файл автоматически загрузится и отобразится

### В AdvancedContentEditor
1. Создайте блок типа "image" или "file"
2. Используйте встроенный FileUploader
3. Файл будет сохранен и отображен

### Тестирование
1. Используйте редактор документации для загрузки файлов
2. Проверьте отображение в предварительном просмотре
3. Убедитесь что файлы доступны по прямым ссылкам

## Мониторинг

### Логи
- Все ошибки загрузки логируются в консоль
- Toast уведомления для пользователя

### Диагностика
- Проверка доступности файлов в браузере
- Информация об ошибках в консоли разработчика

## Решение проблем

### Файлы не отображаются
1. Проверьте пути в browser dev tools
2. Убедитесь, что Render хранилище настроено
3. Проверьте логи API загрузки

### Ошибки загрузки
1. Проверьте размер файла (макс. 10MB)
2. Убедитесь, что формат поддерживается
3. Проверьте права доступа к папке uploads

### Проблемы с Render
1. Убедитесь, что папка `/uploads` существует
2. Проверьте права на запись
3. Убедитесь, что static files правильно настроены

## Заключение

Система загрузки файлов теперь полностью функциональна и готова к работе в production на Render. Все обнаруженные проблемы исправлены, добавлены необходимые fallback механизмы и система тестирования.
