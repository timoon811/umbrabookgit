# Безопасность админ панели Umbra Platform

## Обзор

Данный документ описывает меры безопасности, реализованные для защиты админ панели от несанкционированного доступа.

## Уровни защиты

### 1. Middleware (Промежуточное ПО)

- **Проверка аутентификации**: Все маршруты `/admin/*` требуют валидный JWT токен
- **Проверка роли**: Доступ разрешен только пользователям с ролью `ADMIN`
- **Автоматическое перенаправление**: Неавторизованные пользователи перенаправляются на `/login`
- **Пользователи без прав администратора**: Перенаправляются на главную страницу `/`

### 2. Layout-уровень защиты

- **AdminLayout**: Дополнительная проверка прав на уровне страницы
- **Верификация токена**: Проверка JWT токена и его валидности
- **Проверка базы данных**: Дополнительная проверка статуса пользователя в БД
- **Проверка блокировки**: Блокировка доступа заблокированным пользователям

### 3. API-уровень защиты

- **Все API маршруты `/api/admin/*`**: Требуют права администратора
- **Функция `checkAdminAuth()`**: Централизованная проверка прав
- **Верификация роли**: Проверка роли `ADMIN` в каждом запросе
- **Проверка статуса**: Проверка статуса `APPROVED` и отсутствия блокировки

### 4. Компонент-уровень защиты

- **AdminAccessGuard**: React компонент для условного отображения админ функций
- **UserActions**: Кнопка админ панели показывается только администраторам
- **AuthenticatedHome**: Карточка админ панели скрыта для обычных пользователей
- **Profile page**: Админ функции доступны только администраторам

## Проверки безопасности

### На уровне маршрутов

```typescript
// Middleware проверяет роль для /admin маршрутов
if (adminRoutes.some(route => pathname.startsWith(route))) {
  const isAdmin = await checkAdminRole(token);
  if (!isAdmin) {
    return NextResponse.redirect(new URL("/", request.url));
  }
}
```

### На уровне API

```typescript
// Каждый API маршрут проверяет права
async function checkAdminAuth() {
  const decoded = jwt.verify(token, JWT_SECRET);
  if (decoded.role !== "ADMIN") {
    throw new Error("Недостаточно прав");
  }
}
```

### На уровне компонентов

```typescript
// Условное отображение админ функций
{hasAdminAccess(user) && (
  <Link href="/admin">Админ панель</Link>
)}
```

## Тестирование безопасности

### Запуск тестов

```bash
npm run test:security
```

### Тестируемые сценарии

1. **Доступ без токена**: Проверка перенаправления на `/login`
2. **Доступ с невалидным токеном**: Проверка отклонения запроса
3. **Доступ обычного пользователя**: Проверка перенаправления на `/`
4. **Доступ к API без прав**: Проверка возврата 401 ошибки
5. **Публичные маршруты**: Проверка доступности для всех

## Роли пользователей

### ADMIN
- Полный доступ к админ панели
- Управление пользователями
- Управление курсами и документацией
- Доступ к финансовым данным
- Системные настройки

### USER
- Доступ к курсам и документации
- Личный профиль
- Нет доступа к админ функциям

### MODERATOR, MEDIA_BUYER, SUPPORT
- Специализированные роли
- Ограниченный доступ к админ функциям

## Рекомендации по безопасности

### 1. Регулярные проверки
- Запуск тестов безопасности перед деплоем
- Мониторинг логов доступа к админ панели
- Проверка прав пользователей

### 2. Обновления
- Регулярное обновление JWT секретов
- Мониторинг уязвимостей зависимостей
- Обновление схемы безопасности

### 3. Мониторинг
- Логирование всех попыток доступа к админ панели
- Алерты при подозрительной активности
- Регулярный аудит прав доступа

## Логирование безопасности

Все попытки доступа к админ панели логируются:

```typescript
console.error("Ошибка проверки прав администратора:", error);
console.error("Ошибка верификации токена:", error);
```

## Контакты по безопасности

При обнаружении уязвимостей безопасности:
1. Немедленно сообщите команде разработки
2. Не публикуйте информацию об уязвимости публично
3. Предоставьте детальное описание проблемы

---

**Дата последнего обновления**: $(date)
**Версия документа**: 1.0
