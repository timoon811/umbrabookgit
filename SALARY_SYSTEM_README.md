# Система запросов на зарплату

## Обзор

Система запросов на зарплату позволяет процессорам создавать заявки на выплату заработанных средств, а администраторам - управлять этими заявками.

## Компоненты системы

### 1. Модальное окно запроса на ЗП (`SalaryRequestModal`)

**Расположение:** `src/components/modals/SalaryRequestModal.tsx`

**Функциональность:**
- Выбор периода (начало и конец)
- Указание суммы к выплате
- Детали выплаты (способ, счет/кошелек, дополнительная информация)
- Комментарий к заявке
- Валидация данных
- Автоматический расчет доступной суммы

**Использование:**
```tsx
<SalaryRequestModal
  isOpen={showSalaryModal}
  onClose={() => setShowSalaryModal(false)}
  onSubmit={handleSalaryRequest}
  availableAmount={stats?.balance.available || 0}
  isLoading={submittingDeposit}
/>
```

### 2. API для процессоров (`/api/processor/salary-requests`)

**Расположение:** `src/app/api/processor/salary-requests/route.ts`

**Функциональность:**
- `GET` - получение заявок процессора
- `POST` - создание новой заявки
- Валидация периода и суммы
- Проверка пересечений с существующими заявками
- Автоматический расчет суммы на основе подтвержденных депозитов

### 3. API для администраторов (`/api/admin/salary-requests`)

**Расположение:** `src/app/api/admin/salary-requests/route.ts`

**Функциональность:**
- `GET` - получение всех заявок с фильтрацией и пагинацией
- `PUT` - обновление статуса заявки (одобрение/отклонение)
- `DELETE` - удаление отклоненных заявок
- Автоматическое создание транзакций при одобрении
- Списание средств со счета процессора

### 4. Админ-панель управления заявками (`SalaryRequestsTab`)

**Расположение:** `src/components/admin/SalaryRequestsTab.tsx`

**Функциональность:**
- Отображение всех заявок в табличном виде
- Фильтрация по статусу, процессору, датам
- Поиск по имени процессора
- Сортировка по различным полям
- Статистика по статусам заявок
- Действия: просмотр деталей, одобрение, отклонение, удаление
- Модальные окна для действий и просмотра деталей

### 5. Интеграция в страницу обработки

**Расположение:** `src/app/processing/page.tsx`

**Функциональность:**
- Кнопка "Заявка на ЗП" в интерфейсе процессора
- Отображение доступной суммы для выплаты
- Отправка заявок через модальное окно

### 6. Интеграция в админ-панель

**Расположение:** `src/app/admin/processing/page.tsx`

**Функциональность:**
- Новый таб "Запросы ЗП"
- Отображение количества ожидающих заявок в статистике
- Полнофункциональное управление заявками

## База данных

### Модель `salary_requests`

```prisma
model salary_requests {
  id               String              @id @default(uuid())
  processorId      String
  periodStart      DateTime
  periodEnd        DateTime
  requestedAmount  Float
  calculatedAmount Float?
  paymentDetails   String?             // JSON с деталями выплаты
  comment          String?             // Комментарий процессора
  adminComment     String?             // Комментарий администратора
  status           SalaryRequestStatus @default(PENDING)
  processedAt      DateTime?
  paidAt           DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  processor        users               @relation(fields: [processorId], references: [id], onDelete: Cascade)
}
```

### Статусы заявок

- `PENDING` - Ожидает рассмотрения
- `APPROVED` - Одобрена
- `REJECTED` - Отклонена
- `PAID` - Выплачена

## Бизнес-логика

### Создание заявки

1. Процессор выбирает период и сумму
2. Система проверяет доступность средств
3. Проверяется отсутствие пересечений с существующими заявками
4. Автоматически рассчитывается сумма на основе подтвержденных депозитов
5. Создается заявка со статусом `PENDING`

### Одобрение заявки

1. Администратор одобряет заявку
2. Система создает транзакцию списания
3. Средства списываются со счета процессора
4. Статус заявки меняется на `APPROVED`
5. Заявка помечается как обработанная

### Отклонение заявки

1. Администратор отклоняет заявку
2. Указывается причина отклонения
3. Статус заявки меняется на `REJECTED`
4. Заявка помечается как обработанная

## Безопасность

- Проверка ролей пользователей (PROCESSOR/ADMIN)
- Валидация всех входных данных
- Проверка прав доступа к заявкам
- Логирование всех действий

## Расширения

### Возможные улучшения

1. **Уведомления** - Email/SMS уведомления о статусе заявки
2. **Автоматические выплаты** - интеграция с платежными системами
3. **Шаблоны заявок** - предустановленные периоды и суммы
4. **Массовые операции** - обработка нескольких заявок одновременно
5. **Отчеты** - аналитика по выплатам и заявкам
6. **Интеграция с бухгалтерией** - экспорт данных для учета

### Интеграция с другими системами

- Финансовая система (счета, транзакции)
- Система депозитов (расчет доступных средств)
- Бонусная система (учет начисленных бонусов)
- Система пользователей (роли, права доступа)

## Использование

### Для процессоров

1. Перейти на страницу "Обработка"
2. Нажать кнопку "Заявка на ЗП"
3. Заполнить форму заявки
4. Отправить на рассмотрение

### Для администраторов

1. Перейти в админ-панель → "Управление обработкой"
2. Выбрать таб "Запросы ЗП"
3. Просматривать и управлять заявками
4. Одобрять или отклонять заявки с комментариями

## Технические детали

### Зависимости

- React 18+
- TypeScript
- Tailwind CSS
- Lucide React (иконки)
- Prisma (ORM)
- PostgreSQL (база данных)

### Производительность

- Пагинация для больших списков заявок
- Индексы в базе данных для быстрого поиска
- Кэширование статистики
- Оптимизированные запросы к базе данных

### Мониторинг

- Логирование всех операций
- Отслеживание ошибок
- Метрики производительности
- Алерты при критических ошибках
